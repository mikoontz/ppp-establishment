---
title: "Population size relative time"
author: "Michael Koontz"
date: "2/26/2018"
output: html_document
---

# Purpose

A quick outline of the population size analysis when using a relative amount of time since the final introduction event.

```{r setup}
library(car)
library(ggplot2)
library(lme4)
library(lsmeans)
library(multcompView)
library(tidyr)
library(dplyr)
library(here)

b <- read.csv(here::here("/data/clean-establishment-data.csv"))
b$number <- as.factor(b$number)
b$block <- as.factor(b$block)
b$gap <- as.factor(b$gap)
```

Don't bother assessing the effect of the introduction gap, just filter out those populations

```{r filter_gap}
b <-
  b %>% 
  filter(gap == FALSE)

glimpse(b)
```

# Exploratory data analysis plot

Visualize how many populations were extant 2 generations after their final introduction event would get us up to Generation 7 (as we reported in the paper). Looking 5 generations is as far as we can look, given the limits of our data collection.

```{r eda_visualization_3_after}
ggplot(b, aes(x = N_3_after)) +
  geom_histogram(stat = "count") +
  facet_grid(environment ~ number)
```

```{r eda_visualization_5_after}
ggplot(b, aes(x = N_5_after)) +
  geom_histogram(stat = "count") +
  facet_grid(environment ~ number)
```


# Build some models

## Five generations after final introduction event

We will use a simple random effects structure with temporal block as a random intercept effect

### Influence of fixed effects

```{r fixed_effects_interaction}
# Use LRT tests to guide interpretation, but all fixed effects will remain in the model in the end
m6 <- glmer(N_5_after ~ number*environment + (1 | block), data=b, family=poisson, control=glmerControl(optimizer="bobyqa"))

m7 <- update(m6, formula= .~. - number:environment)

anova(m6, m7)
```

We reject the null hypothesis that the model with the `number*environment` interaction equally as likely than the model without it, so we keep the interaction term and will base all interpretations without averaging across any treatments.

Another way to look at group-level effects like we did with likelihood ratio tests is using a Type II Wald $\chi^2$ test. I think this test is somewhat anti-conservative, but it gives us a good ballpark and corroborates the results from our Likelihood Ratio Test.

```{r wald}
Anova(m6)
```

### Interpretation and contrasts

We'll average across the environment treatments and focus on the introduction regime treatments.

```{r interpretation_and_contrasts_visualize}
# The final model which includes all fixed effects and uses the trimmed dataset without populations that experienced a gap in the introduction period
final <- m6

results <- lsmeans::lsmeans(final, pairwise ~ number, adjust="none")
results
posthoc <- summary(results$lsmeans)

sig_letters <- lsmeans::cld(results, Letters = letters, adjust = "none")$.group[order(cld(results)$number)]
xvals <- 1:length(posthoc$lsmean)
min_y <- min(exp(posthoc$asymp.LCL))

plot(x = xvals, y = exp(posthoc$lsmean), 
     ylim=c(min_y, 50.0), 
     xlim = range(xvals) + c(-0.5, 0.5), 
     las=1, 
     pch=19, 
     xaxt="n", 
     xlab="Introduction regime", 
     ylab="Population size",
     bty="L")

axis(side=1, 
     at = xvals, 
     labels = c("20x1","10x2","5x4","4x5"), 
     tick = FALSE)

arrows(x0 = xvals, 
       y0 = exp(posthoc$asymp.LCL), 
       y1 = exp(posthoc$asymp.UCL), 
       code = 3, 
       length = 0.1, 
       angle = 90, 
       lwd = 2)

text(x = 1:4, y = 47.0, labels = sig_letters)

mtext(side=3, 
      text="Effect of propagule number on population size\nfive generations after final introduction", 
      line = 2)
```

## Two generations after final intro event

This analysis will use generation 7 as the latest possible generation (for the 4x5 intro regime, the 7th generation represents 3 generations after the final introduction.)

```{r three_after}
final_3after <- glmer(N_3_after ~ number*environment + (1 | block), data=b, family=poisson, control=glmerControl(optimizer="bobyqa"))

Anova(final_3after)
```

We still find that number of introductions is the only important predictor. Let's plot:

```{r visualize_3_after}
results_3after <- lsmeans::lsmeans(final_3after, pairwise ~ number, adjust="none")
results_3after
posthoc_3after <- summary(results_3after$lsmeans)

sig_letters_3after <- lsmeans::cld(results_3after, Letters = letters, adjust = "none")$.group[order(cld(results_3after)$number)]

xvals_3after <- 1:length(posthoc_3after$lsmean)
min_y_3after <- min(exp(posthoc_3after$asymp.LCL))

plot(x = xvals_3after, y = exp(posthoc_3after$lsmean), 
     ylim=c(min_y_3after, 65.0), 
     xlim = range(xvals_3after) + c(-0.5, 0.5), 
     las=1, 
     pch=19, 
     xaxt="n", 
     xlab="Introduction regime", 
     ylab="Population size",
     bty="L")

axis(side=1, 
     at = xvals_3after, 
     labels = c("20x1","10x2","5x4","4x5"), 
     tick = FALSE)

arrows(x0 = xvals_3after, 
       y0 = exp(posthoc_3after$asymp.LCL), 
       y1 = exp(posthoc_3after$asymp.UCL), 
       code = 3, 
       length = 0.1, 
       angle = 90, 
       lwd = 2)

text(x = 1:4, y = 60.0, labels = sig_letters_3after)

mtext(side=3, 
      text="Effect of propagule number on population size\nthree generations after final introduction", 
      line = 2)
```

# Simulation results

```{r explore_sim_results}
#### Read and prepare data from the simulations ####
sims_results_raw <- read.csv(here::here("data/simulations/simulation_stats_raw.csv"), stringsAsFactors = FALSE)

sims_results_3after <- 
  sims_results_raw %>% 
  select(size, number, extant_prop_3after, extant_prop_3after_var, N_3after, N_3after_var)

```

```{r modify}

# Do not average over the environment treatments because there is a significant effect of environment on mean abundance
sims_popSize <- 
  sims_results_3after %>%
  select(size, number, N_3after, N_3after_var) %>% 
  gather(key = env, value = mean_N, -(1:2)) %>% 
  mutate(env = ifelse(env == "N_3after", yes = "stable", no = "fluctuating")) %>% 
  mutate(intro_regime = paste(size, number, sep = "x"))


#### Read samples data to put the equilibrium abundance value on the abundance plot ####
samps <- read.csv(here::here("data/NBBg-samples/NBBg-samples-combined.csv"))

equilibrium_popSize <- log(samps$R0) / samps$alpha

```

# Plot again with simulation results

```{r plot_with_sims}
popSize_model <- glmer(N_3_after ~ number*environment + (1 | block), data=b, family=poisson, control=glmerControl(optimizer="bobyqa"))

popSize_results <- lsmeans::lsmeans(popSize_model, pairwise ~ environment + number, adjust="none")
popSize_posthoc <- summary(popSize_results$lsmeans)

popSize_sig_letters <- lsmeans::cld(popSize_results, Letters = letters, sort = FALSE, adjust = "none")$.group
popSize_sig_letters <- gsub(popSize_sig_letters, pattern = " ", replacement = "")

offset_xvals <- function(x, offset) {
  c(sapply(x, FUN = function(j) c(j - offset, j + offset)))
}
popSize_xvals <- offset_xvals(1:4, 0.1)

min_y <- min(c(exp(popSize_posthoc$asymp.LCL), sims_popSize$mean_N))
max_y <- max(exp(popSize_posthoc$asymp.UCL))
xlim <- range(popSize_xvals) + c(-0.4, 0.4)

# pdf("figures/population-size-experiment-and-simulations.pdf", height = 3.14961, width = 3.14961)
par(mar = c(3.5, 3.25, 0.5, 0.25), family = "Helvetica", mgp = c(2.0, 1, 0))

plot(x = popSize_xvals, y = exp(popSize_posthoc$lsmean),
     type = "n", # Set the plot up, but do not print lines yet
     ylim = c(-10, max_y + 4), 
     xlim = xlim, 
     las = 1, 
     pch = 1, 
     xaxt = "n",
     yaxt = "n",
     xlab = NA, 
     ylab = "Population size")

mtext(side = 1,
      text = "Introduction regime",
      line = 2)

segments(x0 = popSize_xvals, 
         y0 = exp(popSize_posthoc$asymp.LCL), 
         y1 = exp(popSize_posthoc$asymp.UCL), 
         lwd = 2)

points(x = popSize_xvals[c(1, 3, 5, 7)], y = exp(popSize_posthoc$lsmean[c(1, 3, 5, 7)]),
       pch = 1,
       type = "b")

points(x = popSize_xvals[c(2, 4, 6, 8)], y = exp(popSize_posthoc$lsmean[c(2, 4, 6, 8)]),
     pch = 19,
     type = "b")

axis(side = 1, 
     at = 1:4, 
     labels = c("20x1", "10x2", "5x4", "4x5"), 
     tick = FALSE,
     line = -0.5)

axis(side = 2,
     at = seq(0, 60, by = 20),
     las = 1,
     hadj = 0.75)

legend("bottomleft",
       inset = c(0, -0.025),
       legend = c("fluctuating", "stable"), 
       pch = c(0, 15),
       bty = "n")

legend("bottom",
       inset = c(0, 0.15),
       legend = "equilibrium size", 
       lty = 2,
       lwd = 2,
       bty = "n")

legend("bottomright",
       inset = c(0, -0.025),
       legend = c("microcosm", "simulation"), 
       pch = c(19, 17),
       bty = "n")

text(x = popSize_xvals, y = max_y + 9, labels = popSize_sig_letters, pos = 1)

sims_xvals <- offset_xvals(popSize_xvals, offset = 0.05)
#### Add simulation results to the plot ####
# segments(x0 = sims_xvals[seq(1, length(sims_xvals), by = 2)], x1 = sims_xvals[seq(2, length(sims_xvals), by = 2)], y0 = sims_popSize$mean_N, lwd = 4)

points(x = popSize_xvals[c(1, 3, 5, 7)], y = sims_popSize$mean_N[c(1, 3, 5, 7)],
       pch = 2)

points(x = popSize_xvals[c(2, 4, 6, 8)], y = sims_popSize$mean_N[c(2, 4, 6, 8)],
       pch = 17)

segments(x0 = xlim[1], x1 = xlim[2], y0 = mean(equilibrium_popSize), y1 = mean(equilibrium_popSize), lty = "dashed", lwd = 2)

# dev.off()

```

